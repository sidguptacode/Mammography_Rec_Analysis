---
title: "Raw mammography demographics identify important lifestyle features when recommending a screening"
subtitle: "TODO"
author: 
  - TODO
thanks: "Code and data are available at: https://github.com/sidguptacode/Mammography_Rec_Analysis"
date: "`r format(Sys.time(), '%d %B %Y')`"
abstract: "TODO"
output:
  bookdown::pdf_document2
toc: FALSE
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("bookdown")
#install.packages('gridExtra')
#install.packages("hash")
library(hash)
library(dplyr)
library(forcats)
library(knitr)
library(janitor)
library(tidyverse)
library(tidyr)
library(wrapr)
library(haven)
library(ggplot2)
library(gridExtra)
```

#Abstract

The existing recommendation to receive a mammogramaphy in the US is the age of 40, which might be influential as the raw data shows since the rate of mammography screening past that age is significantly increased. In their paper, Einav et al. found that breast cancer mortality does not increase significantly past the age of 40, suggesting that this recommendation should be reworked. In this paper,r we replicate the study done by Einav et al. and extend it by visualizing mammography screening rates by age for different states in the US as well as visualizing the screening rates by age for patients with and without health insurance. Our extensions identify which states and insurance groups are most influenced by the original recommendation and would benefit most by a reworked version, suggesting priority can be assigned to the groups we find for reworking mammography recommendations. 

# Introduction

Cancer is one of the most detrimental diseases of the 21st century. Besides it has many types, breast cancer is the most common cancer in women worldwide and the second most common cancer overall according to World Cancer Research Fund [@intro1]. Because breast cancer is a big part of the detrimental cancer family, it is important to use the right tools at the right time for the right people to diagnose. There are several screening tools for breast cancers such as mammography, MRIs, or clinical breast examination [@intro2]. Recent research suggests that the number of women who received mammograms has been increasing significantly and mammograms might even be overused at an earlier age [@intro3].  Moreover, it is one of the most common myths that mammograms guarantee that breast cancer will be found early with the utilization of mammograms. However, in fact that is not completely true. Although mammograms are the greatest tools for breast cancer diagnosis, they do not guarantee true detection at early stages [@intro4]. 
When the ambiguity of the true benefit of mammograms on early age women is taken into consideration, it is also important to assess potential saved costs related to redundant mammograms. According to a Yale-led research, “... over 40% of the eligible, privately insured women ages 40-49 received annual breast cancer screening in 2017 and estimated the national cost of those procedures to be 2.16 billion dollars per year” [@intro5]. Furthermore, costs being different from state to state are highest in California, New York, Alaska, Wisconsin, and Michigan, whereas lowest in Alabama and Arkansas, and the mean cost of breast cancer screening is 353 dollars per year ranging from 151 dollars to 751 dollars [@intro6]. Putting all together, it might be important and essential to reduce the number of mammography utilized not only to save costs economically but also to redistribute resources in the medical area. Reduction in redundant mammography utilization might also decrease the total amount of harm caused to receivers especially in the early stage [@intro7].  
	In this paper, we replicated Einav et al.’s paper named “Screening and Selection: The Case of Mammograms.” Despite the common belief, the study suggests that the age of 40 might not be the right age to start mammogram screening and might cause redundancy in utilization of mammograms. According to the Einav et al.’s paper, patients who self-select screening at earlier ages are more likely to have cancer than patients who start screening at the age of 40 [@intro8]. Similarly, shifting age for screening recommendation might cause more deaths depending on characteristics of responders [@intro8]. So, it is important to consider several characteristics when there is a potential recommendation for screening. It is also important to have a reworked version for the optimal screening recommendation age not only to minimize mortality but also to identify and to benefit the group who would get affected the most from the new recommendation. 
	Replicating Einav et al.’s paper, this paper’s initial hypothesis is that different groups will be affected differently from the new reworked version of screening recommendation. Our extensions identify which states and insurance groups are most influenced by the original recommendation and would benefit the most by a reworked version. To do that, we first looked at the distribution of breast-cancer deaths across the age and the share of women who received mammogram screening each year by age. In order to decide whether there will be a group who would get affected differently as a result of a new recommendation age, we also checked out the current differences depending on characteristics. For example, we looked at mammogram counts of receivers by age depending on the state they are in. Similarly, we also observed mammogram counts by age and whether the receiver has a health insurance, no health insurance, does not know whether they have any health insurance, and refused to tell whether they have a health insurance. These observations are important to elaborate on Einav et al.’s paper to assess which groups by any characteristics would be more likely to be vulnerable and to get affected more as a result of a potential recommendation change. 
The paper follows the sections of Data in which we talk about the data in detail and analyze the plots we have. Then the Results section will elaborate more on the analysis of data from different aspects. In the Discussion part, we will mention some of the weaknesses and biases of the paper as well as potential further research areas.  



```{r}
################ Begin the data reading process ################
```

```{r, echo = FALSE, message=FALSE, cache=TRUE}
# Read all of the BRFSS datasets (this takes some time, and should only be run once on startup).

# Store all the dataset paths in a list.
brfss_data_paths <- list("inputs/data/CDBRFS00.XPT",  "inputs/data/cdbrfs02.xpt", "inputs/data/CDBRFS04.XPT",  "inputs/data/CDBRFS06.XPT",  "inputs/data/CDBRFS08.XPT",  "inputs/data/CDBRFS10.XPT",  "inputs/data/LLCP2012.XPT")

#brfss_data_paths <- list("inputs/data/CDBRFS08.XPT")

# Define a function to read an XPT file as a dataframe.
read_xpt_file <- function(xpt_file_path) {
  xpt_df <- read_xpt(
    here::here(xpt_file_path),
    skip = 0,
    n_max = Inf,
    .name_repair = "unique"
  )
  return(xpt_df)
}

# Define a function to clean a BRFSS dataframe.
clean_brfss_df <- function(brfss_data) {
  ###   Intakes a BRFSS dataframe, selects the relevant columns, and cleans the values for states.
  ###   brfss_data: a tibble dataframe
  # Check if this dataframe has mammography columns. If not, we just return an empty dataframe.
  brfss_cleaned <-
    brfss_data |>
    clean_names()
  brfss_cols <- colnames(brfss_cleaned)
  if(!( ("rfmam2y" %in% brfss_cols) & ("mam502y" %in% brfss_cols) & ("hadmam" %in% brfss_cols) & ("hlthplan" %in% brfss_cols) ) ) {
    return(data.frame())
  }
  
  # Clean and rename the mammography columns.
  brfss_cleaned <-
    brfss_cleaned |>
    rename(over_40_person_had_mam = rfmam2y,over_50_person_had_mam = mam502y)

  # Remove all rows which have no mammography information.
  brfss_mam <-
    brfss_cleaned |>
    filter(!(is.na(over_40_person_had_mam) & is.na(over_50_person_had_mam) & is.na(hadmam)))

  # Run the RScript which reads the CSVs for the FIPS codes in the States.
  states_fips <- read_csv(here::here("inputs/data/states_fips.csv"))
  # The `state` column represents states as FIPS codes. Use a hash-map to substitute FIPS with state abbreviations.
  state_hashmap <- new.env()
  for (row in 1:nrow(states_fips)) {
    state_fip <- as.character(states_fips[row, "st"])
    state_name <-  as.character(states_fips[row, "stusps"])
    state_hashmap[[state_fip]] <- state_name
  }

  # Perform the cleaning of states names.
  brfss_states_cleaned <-
    brfss_mam |>
    # Some states have FIPS codes > 56, which is the maximum. This is for participants who did not respond with a state. We remove those participants.
    filter(state <= 56) |>
    mutate(state = as.character(state))
  # This applies the hashmap to each state.
  brfss_states_cleaned$state <- unlist(mget(unlist(brfss_states_cleaned$state), envir=state_hashmap))
  
  # Now select only the columns that we care about to save memory.
  brfss_cleaned <- 
    brfss_states_cleaned |>
    select(age, state, hadmam, over_40_person_had_mam, over_50_person_had_mam, hlthplan)

  return(brfss_cleaned)
}

# For each BRFSS path, read it and clean it. lappy does this, and returns a list of cleaned BRFSS dataframes.\
read_and_clean_brfss <- function(xpt_file_path) {
  brfss_data <- read_xpt_file(xpt_file_path)
  brfss_cleaned <- clean_brfss_df(brfss_data)
  print(paste("Sucessfully read: ", xpt_file_path, sep=" "))
  return(brfss_cleaned)
}
brfss_dfs <- lapply(brfss_data_paths, read_and_clean_brfss)

# Concatenate all of the BRFSS dataframes into one
brfss_data <- do.call(rbind, brfss_dfs)

```


```{r, echo = FALSE, message=FALSE, warning=FALSE}
# Read the data about breast cancer deaths.
bc_deaths <- read.delim(
  here::here("inputs/data/bc_deaths_1959_2010.txt"), sep = ",")
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
################ Begin plotting: Figure 1 ################
```

<<<<<<< HEAD
=======
\@ref{mammogram_rate}

>>>>>>> 6da9b95072069ebcb451163a3b32db19f4df7b38
```{r mamogram_rate, fig.align='center'}

dist_mam <- 
  brfss_data |>
  group_by(age) |>
  summarize(n = n()) |>
  drop_na()

dist_mam2 <- brfss_data |>
  filter(hadmam == 1 & hlthplan == 1)|>
  group_by(age) |>
  summarize(mam_ct = sum(hadmam))

dist_mam3 <- dist_mam |> 
  cbind(dist_mam2$mam_ct) |>
  rename(mam_ct = 'dist_mam2$mam_ct') |>
  mutate(share = mam_ct/n)
  
dist_mam3 |>
ggplot(aes(age, share, fill = "BRFSS Survey"))+
  geom_point(color = "grey")+
  geom_line(color = "grey")+
  xlim(35, 50)+
  scale_y_continuous(breaks=seq(0, 0.7, by = 0.1))+
  labs(x = "Age", y ="Share who had a mammogram",
       title = "Mammogram rate in survey, by age")+
  theme_minimal()


```

```{r breast_cancer_deaths, replicate Figure5}

dist_deaths <- bc_deaths |>
  group_by(age) |>
  summarize(deaths = sum(bc_deaths))
dist_deaths |> ggplot(aes(age, deaths, fill = "BRFSS Survey"))+
  geom_point(color = "grey")+
  geom_line(color = "grey")+
  xlim(35, 50)+
  scale_y_continuous(breaks=seq(0, 0.7, by = 0.1))+
  labs(x = "Age", y ="Share who had a mammogram",
       title = "Mammogram rate in survey, by age")+
  theme_minimal()
```

```{r}
################ Begin plotting: Our custom figures ################
```

```{r}
# Helper functions which we will use.
single_df_barplot <- function(df, xcol, xlab, ylab, title, font_size) {
  ###   Intakes a dataframe with two columns representing x, y values, and plots a bar plot.
  ###   Arguments and preconditions:
  ###   df: a tibble dataframe
  ###   xcol: a character string denoting the column for the x-values in the df
  ###   ycol:  a character string denoting the column for the y-values in the df
  ###   title: a character string denoting the title of the plot
  ###   xlab:  a character string denoting the x-label of the plot
  ###   ylab:  a character string denoting the y-label of the plot
  ###   large_font: a number determining the font size of the plots.
  ###   xcol and ycol must be columns in df.
  barplot <- ggplot(data=df, aes(.data[[xcol]])) +
    geom_bar() +
    ggtitle(title) +
    xlab(xlab) +
    ylab(ylab) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    theme(text = element_text(size = font_size)) 
  return(barplot)
}


plot_df_group <- function(df, group_col, plot_fn) {
  ###   Intakes a dataframe with a column, and returns a grid of plots.
  ###   Example: if group_col is STATE, then this function creates 50 plots in a grid, each containing data for each state.
  ###   df: a tibble dataframe
  ###   group_col: a character string denoting the column for to group by
  ###   plot_fn: an R function used to plot the dataframes.
  df_groups <- split(df, df[[group_col]])
  df_plots <- lapply(df_groups, plot_fn)
  num_plots <- length(df_plots)
  num_cols <- floor(sqrt(num_plots))
  do.call("grid.arrange", c(df_plots, ncol=num_cols))
}
```

```{r mamograms_by_state, fig.width=20, fig.height=20} 
plot_df_group(brfss_data, "state", function(df) {single_df_barplot(df, "age", "Age", "Count", paste("Mammography count ", df$state[1], sep=" "), 32)})
```


```{r mamograms_by_insurance, fig.width=20, fig.height=10}  
# Substitute the health insurance responses (in integer format) using a hashmap that maps it to a human-readable string.
health_ins_map <- new.env()
health_ins_map[['1']] = 'health insurance: yes'
health_ins_map[['2']] = 'health insurance: no'
health_ins_map[['7']] = 'health insurance: I don\'t know'
health_ins_map[['9']] = 'health insurance: refused'

plot_df_group(brfss_data, "hlthplan", function(df) {single_df_barplot(df, "age", "Age", "Count", paste("Mammography count - ", health_ins_map[[as.character(df$hlthplan[1])]], sep=" "), 40)})
```

# Data

Implementation wise, we replicated and extended Einav et al’s study using the R programming language [@citeR]. We started by downloading the BRFSS dataset for each year from the CDC website, and loading it using the Tidyverse and Tidyr libraries [@thereferencecanbewhatever] [@tidyrcite].
The BRFSS datasets were downloaded in XPT format, and were read into dataframes using the Haven library [@havencit]. Each dataframe was cleaned in the same way, using the renaming and removal functionality in the Janitor, Wrapr, and Forcats libraries [@janitorcite] [@wraprcite] [@forcatscite]. Each US state in the BRFSS was represented with its FIPS code, and we wanted to represent the states using their two-letter abbreviations instead. To do this, we made use of another dataset that contained a CSV of state FIPS codes and state abbreviation codes [@bureau_2021]. We created a hashmap using the Hash library [@hashcite], and renamed each FIPS code with its state abbreviation. Columns about mammography, state, and healthplan were then selected using the dplyer library [@dplyer]. We also used hashmaps to map the code responses from the health insurance column to human-interpretable values (for instance; 1 is a yes, 2 is a no). Each dataframe was finally concatenated into one final dataframe, and the ggplot2 library [@ggplot2cite] was used to generate all of our figures.


To begin our study, we replicated a visualization from Einav et al’s study which plots the distribution of mammograms across different age groups, as shown in Figure \@ref(fig:mamogram_rate). As mentioned, we constrained our study to use open-source data, and so our plot differs from Einav et al's study as it does not plot results from the private-access HCCI claims dataset. We only used data from the even years from 2000 to 2012 and filtered out participants without health insurance; however in our extensions we use data from every year in the BRFSS and included participants without health insurance. The trendline we created is a cumulative function of the percentage of those who have received annual mammograms by their age. As shown in the graph, it should be strictly increasing since it is cumulative. The data was gathered from the Behavioral Risk Factor Surveillance System Survey (BRFSS), even years 2000-2012. From the figure, we can see that at the age of 35, the share who received an annual mammogram is around 20 percent. More women started taking annual mammograms from age 35 to age 42 as age increased. At 42, around 65 percent of the women population have received annual mammograms. After 42, the growth rate declines significantly, and it keeps around  80 percent. At the end of this trendline, there is still 20 percent of the women who have not received a screening mammogram each year, and they are unlikely to have them if they did not start it before 42. 


  The first figure we created shows the share of women who received a screening mammogram each year, by age. We are trying to replicate  figure A.1. from the original paper. Since we don’t have the dataset of the HCCI claims data. We replicated only the trendline with respect to the BRFSS survey.  The trendline we created is a cumulative function of the percentage of those who have received annual mammograms by their age. It should be strictly increasing as shown in the graph since it is cumulative. The data was gathered from Behavioral Risk Factor Surveillance System Survey (BRFSS), even years 2000-2012. From the figure we can see that at the age of 35, the share who received an annual mammogram is around 20 percent. From age 35 to age 42, as age increases,more women started taking annual mammograms as well. . At the age of 42, around 65 percent of the women population have received annual mammograms. After 42, the growth rate declines significantly and it keeps around  80 percent. At the end of  this trendline, there is still 20 percent of the women who haven't received a screening mammogram each year and they are unlikely to have them if they didn’t start it before 42. 


#Discussion

<<<<<<< HEAD
In this paper, we replicate the original paper by making the Mammography rates versus age graph. We also create a figure comparing mammography screening amounts with different states in the US. Apart from these, we visualize the screening rates by age for patients with and without health insurance. We learned that senior citizens tend to take less mammography screening without health insurance from our figures. Since in the US,  the average cost for screening mammography ranges from about $100 to $250, [@costofmam] our results suggest that old citizens are less willing to spend money on Mammography screenings. Another finding we discovered from our figures is that some states have been more influenced by mammography recommendations at 40 than others. Unfortunately, we do not have enough data to investigate the relationship between breast cancer mortality rates and the share of having mammography screening in the population. However, our research shows that there is no evidence they are related.
=======
In this study, we are particularly interested in the screening mammography rates, so we select the relevant information that might be relevant to taking mammography from the original data. To study how widespread mammography screenings are in each age group of the population and visualize the growth in the number of people opting for a mammography screening,  we replicate the original paper by making the Mammography rates versus age graph with women who have health insurance. Since our data is based on the U.S. population, and unlike Canada, each state in the U.S. will have different health insurance policies against mammograms. The public acceptance of mammography screening might also vary. To further investigate what groups are most influenced by the original recommendation age (40),  we divide our data into different states of the U.S. We create figures comparing mammography screening amounts versus age under each state. We did another group division by comparing people with health insurance and people without health insurance to extend our work. We believe that one of the reasons to influence someone to take a mammogram is whether they have health insurance. To extend our work, we visualize the screening rates by age for patients with and without health insurance and try to compare how the distributions in each age group perform.

	In Figure \@ref(fig:mamogram_rate), we found that at the age of 43, the growth of the share who have had mammograms slows down and keeps its level around 70 percent, which means that around 30 percent of the female eventually choose not to take the mammography screenings. The reason behind this choice varies. They may not believe mammograms prevent breast cancers or are confident about their health conditions, or their insurance only covers a portion of the expense, and they are not willing to spend on mammographs. Figure \@ref(fig:mamograms_by_state) discovered that some states had been more influenced by mammography recommendations at 40 than others. We see a skewness in the distribution of the bar chart. When it skews to the left, people tend to have mammograms early, favouring the original recommendation age. States such as A.K., DC, and G.A. have skewed distributions to the left. Likewise, when it skews to the right, people tend to have the mammographs later, favouring the new recommendation age. States such as N.E., AZ, and F.L. have skewed distributions to the left. Apart from these, we visualize the screening rates by age for patients with or without health insurance. In Figure \@ref(fig:mamograms_by_insurance), we learned that senior citizens tend to take less mammography screening without health insurance. Since in the U.S.,  the average cost for screening mammography ranges from about 100 dollars to 250 dollars, [@costofmam] our results suggest that old citizens are less willing to spend money on Mammography screenings. Again, possible reasons for this might be that senior people have less trust in mammography since it is a relatively new technology. They might also think that mammography screenings are overpriced, so they do not want to spend that much on examinations.  
>>>>>>> 6da9b95072069ebcb451163a3b32db19f4df7b38

One of the significant weaknesses of the paper is that our data sources are minimal. We only have one dataset from the BRFSS survey results. It would be better to have data from other sources as a comparison since, firstly, we cannot guarantee that the sample selection process of the BRFSS survey is randomly selected. It may not be representable to the rest of the population in the U.S. . As a result, our data collected may be biased towards certain groups of people. Secondly, biases are caused by the nature of the survey; refusing to answer is one option for each question. This will affect the accuracy of our data counts as well. There are many different kinds of mammograms. For example, film-screen mammograms and digital mammograms are two different types of imaging, however diagnose different things. Unfortunately, the dataset we have does not indicate which type of mammograms the participant took. They are all performed in the same manner. The only difference is whether the photos are captured on photographic film or as digital files stored on a computer. [@breastcancer] In addition, there are other imaging diagnoses that are taken on the breast area, such as MRIs, which are also meant to diagnose fundamentally different diseases. It is very easy for a participant to then confuse a mammogram with those diagnoses as well. The solution for minimizing the confusion among the participants is to have the definitions of mammograms stated in the questionnaire or explain them via phone when they receive the survey. We could investigate the accuracy of different types of mammography screenings with more data. Another weakness is that we cannot verify whether breast cancer mortality rates went down with regular mammography screening by using our data. We also have no way of verifying if a reworking of age recommendations would reduce the number of deaths caused by breast cancer. Other health problems caused by frequent mammograms might have more considerable consequences than the effect of preventing breast cancer. However, unfortunately, we do not have enough data to start this investigation. 

<<<<<<< HEAD
One of the significant weaknesses of the paper is our data sources are minimal. We only have one dataset from the BRFSS survey results. People taking the survey may not represent the rest of the population in the US; as a result, our data collected may be biased towards certain groups of people. Another weakness is we cannot verify whether breast cancer mortality rates went down with regular mammography screening by using our data. To extend our study in the future, we can investigate the relationship between mammography rates and other interesting variables, such as physical breast exams. A physical breast exam is another common exam for checking breast cancers. It can detect a lump in your breast and other changes that might require more testing. [@parenthood]  It is controversial whether women should take one or the other or both. Last but not least, for the further step, we can build a prediction model for predicting the breast cancer survival rates with the mammography rates variable and age variable.
=======
To extend our study, we can investigate the relationship between mammography rates and other interesting variables, such as physical breast exams. A physical breast exam is another common exam for checking breast cancers. It can detect a lump in the breast as well as other alterations that may necessitate further investigation.[@parenthood]  It is controversial whether women should take one or the other or both. Last but not least, for the further step, we can build a prediction model for predicting the breast cancer survival rates with the mammography rates variable and age variable. We can build a prediction model for predicting breast cancer survival rates and mammography rates, and age. To be more specific, we can build a Poisson regression model. Because our outcome variable is a count, we can make use of Poisson regression, often known as a log-linear model. In our case, the count variable is the number of breast cancer deaths, and that will be our model output. The input variables, or features to the model would be mammography counts at different age intervals. For example, we could have a feature vector of size 10, with the first feature representing the number of mammograms from participants between ages 10 and 20, the second feature representing the number of mammograms from participants between ages 20 and 30, all the way up to the last feature representing mammograms from participants between ages 90 to 100. After we fit our data into the model, we will get all the estimated coefficients. Using this model, we can test the relationships between each variable and the numbers of breast cancer deaths. We could also look at the p values and the confidence intervals of our estimated coefficients to determine if the variables we choose are significant. 
>>>>>>> 6da9b95072069ebcb451163a3b32db19f4df7b38


# References


